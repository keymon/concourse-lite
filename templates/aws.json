{
  "variables": {
    "comment": "trusty 14.04.3 eu-west-1 ssd",
    "base_ami": "ami-b65101c1",
    "region": "eu-west-1",
    "version": "0"
  },
  "builders": [{
    "type": "amazon-ebs",
    "ami_name": "concourse-{{user `version`}}",
    "ami_groups": ["all"],
    "instance_type": "m1.large",
    "region": "{{user `region`}}",
    "source_ami":  "{{user `base_ami`}}",
    "ssh_username": "ubuntu",
    "ami_description": "GDS Concourse AMI (version {{user `version`}})"
  }],
  "provisioners": [{
    "type": "shell",
    "inline": "while [ ! -f /var/lib/cloud/instance/boot-finished ] ; do sleep 1; done"
  },{
    "type": "shell",
    "execute_command": "echo 'vagrant' | {{ .Vars }} sudo -S -E {{ .Path }}",
    "scripts": [
      "scripts/update-resolv.conf.sh",
      "scripts/quiet-tty-warning.sh",
      "scripts/apt-update.sh",
      "scripts/update-trusty-kernel.sh",
      "scripts/kernel-cleanup.sh",
      "scripts/admin-sudoers.sh",
      "scripts/increase-loop-devices.sh",
      "scripts/setup-syslog.sh"
    ]
  },{
    "type": "shell",
    "execute_command": "echo 'vagrant' | {{ .Vars }} sudo -S -E {{ .Path }}",
    "scripts": [
      "scripts/aws-grub.sh",
      "scripts/aws-preseed.sh",
      "scripts/vagrant-pub-key.sh"
    ]
  },{
    "type": "file",
    "source": "concourse_linux_amd64",
    "destination": "/tmp/concourse"
  },{
    "type": "shell",
    "execute_command": "echo 'vagrant' | {{ .Vars }} sudo -S -E {{ .Path }}",
    "inline": "install /tmp/concourse /usr/local/bin/concourse"
  },{
    "type": "file",
    "source": "upstart/concourse-worker.conf",
    "destination": "/tmp/concourse-worker.conf"
  },{
    "type": "file",
    "source": "upstart/concourse-web.conf",
    "destination": "/tmp/concourse-web.conf"
  },{
    "type": "shell",
    "execute_command": "echo 'vagrant' | {{ .Vars }} sudo -S -E {{ .Path }}",
    "inline": "mv /tmp/concourse-*.conf /etc/init"
  },{
    "type": "shell",
    "execute_command": "echo 'vagrant' | {{ .Vars }} sudo -S -E {{ .Path }}",
    "scripts": [
      "scripts/generate-concourse-keys.sh",
      "scripts/setup-postgresql.sh"
    ]
  },{
    "type": "shell",
    "execute_command": "echo 'vagrant' | {{ .Vars }} sudo -S -E {{ .Path }}",
    "scripts": [
      "scripts/clean-up.sh",
      "scripts/shrink-disk.sh"
    ]
  }],

  "post-processors": [{
    "type": "vagrant",
    "keep_input_artifact": true,
    "vagrantfile_template": "templates/vagrant-aws.tpl",
    "output": "concourse-{{ .Provider }}-ubuntu-trusty-{{user `version`}}.box"
  }]
}
